<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCZ URL Shortener - Dashboard</title>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #333; }
        h2 { margin-bottom: 15px; color: #374151; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 28px; font-weight: bold; color: #2563eb; }

        /* –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ */
        .create-form { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #374151; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
        .form-hint { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .form-actions { display: flex; gap: 12px; margin-top: 20px; }

        /* –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ */
        .url-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 16px; margin-bottom: 12px; position: relative; }
        .url-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .url-item-header h4 { font-size: 14px; color: #374151; font-weight: 600; }
        .btn-remove { background: #dc2626; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .btn-remove:hover { background: #b91c1c; }
        .btn-add { background: #16a34a; }
        .btn-add:hover { background: #15803d; }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è */
        .results-box { margin-top: 20px; }
        .summary { background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .summary-stats { display: flex; gap: 20px; margin-top: 8px; }
        .summary-stat { font-size: 14px; }
        .summary-stat strong { font-size: 18px; display: block; }
        .result-item { border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .result-item.success { background: #f0fdf4; border-color: #86efac; }
        .result-item.error { background: #fee2e2; border-color: #fca5a5; }
        .result-url-display { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .result-url-display input { flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; font-size: 13px; }
        .result-details { font-size: 13px; color: #6b7280; margin-top: 8px; }
        .error-details { color: #991b1b; font-size: 13px; margin-top: 8px; }

        table { width: 100%; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; color: #374151; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        tbody tr:last-child td { border-bottom: none; }
        tr:hover { background: #f9fafb; }
        .loading { text-align: center; padding: 40px; color: #666; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .error { background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #fecaca; }
        .btn { padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-primary { background: #dbeafe; color: #1e40af; }
        .empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .empty-state h3 { color: #666; margin-bottom: 10px; }
        .empty-state p { color: #999; }
        .domain-info { display: flex; flex-direction: column; gap: 4px; }
        .domain-name { font-weight: 600; color: #1f2937; font-size: 15px; }
        .domain-desc { font-size: 13px; color: #6b7280; }
        .date-info { font-size: 12px; color: #9ca3af; }
    </style>
</head>
<body>
<div class="container" x-data="dashboard()" x-init="init()">
    <h1>üîó MCZ URL Shortener</h1>

    <div class="stats">
        <div class="stat-card">
            <h3>–í—Å–µ–≥–æ –¥–æ–º–µ–Ω–æ–≤</h3>
            <div class="value" x-text="stats.totalDomains"></div>
        </div>
        <div class="stat-card">
            <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤</h3>
            <div class="value" x-text="stats.activeDomains"></div>
        </div>
        <div class="stat-card">
            <h3>–î–µ—Ñ–æ–ª—Ç–Ω—ã–π –¥–æ–º–µ–Ω</h3>
            <div class="value" style="font-size: 16px;" x-text="stats.defaultDomain"></div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏ -->
    <div class="create-form">
        <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Å—ã–ª–∫–∏</h2>

        <form @submit.prevent="createShortLinks">
            <template x-for="(item, index) in form.urls" :key="index">
                <div class="url-item">
                    <div class="url-item-header">
                        <h4>–°—Å—ã–ª–∫–∞ #<span x-text="index + 1"></span></h4>
                        <button
                                type="button"
                                class="btn-remove"
                                @click="removeUrl(index)"
                                x-show="form.urls.length > 1"
                                :disabled="form.submitting"
                        >
                            ‚úï –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>

                    <div class="form-group">
                        <label :for="'url-' + index">URL –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è *</label>
                        <input
                                type="url"
                                :id="'url-' + index"
                                x-model="item.url"
                                placeholder="https://example.com/very/long/url"
                                required
                                :disabled="form.submitting"
                        >
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label :for="'custom-' + index">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input
                                    type="text"
                                    :id="'custom-' + index"
                                    x-model="item.custom_code"
                                    placeholder="my-custom-link"
                                    pattern="[a-zA-Z0-9_-]+"
                                    :disabled="form.submitting"
                            >
                        </div>

                        <div class="form-group">
                            <label :for="'domain-' + index">–î–æ–º–µ–Ω</label>
                            <select
                                    :id="'domain-' + index"
                                    x-model="item.domain"
                                    :disabled="form.submitting"
                            >
                                <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                                <template x-for="domain in activeDomains" :key="domain.domain">
                                    <option :value="domain.domain" x-text="domain.domain"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>
            </template>

            <div class="form-actions">
                <button type="submit" class="btn" :disabled="form.submitting">
                    <span x-show="!form.submitting">‚ú® –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫–∏ (<span x-text="form.urls.length"></span>)</span>
                    <span x-show="form.submitting">‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...</span>
                </button>
                <button type="button" class="btn btn-add" @click="addUrl" :disabled="form.submitting">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë
                </button>
                <button type="button" class="btn btn-secondary" @click="resetForm" :disabled="form.submitting">
                    –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                </button>
            </div>
        </form>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è -->
        <template x-if="results.show">
            <div class="results-box">
                <div class="summary">
                    <strong>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è</strong>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <strong x-text="results.summary.total"></strong>
                            –í—Å–µ–≥–æ
                        </div>
                        <div class="summary-stat" style="color: #16a34a;">
                            <strong x-text="results.summary.successful"></strong>
                            –£—Å–ø–µ—à–Ω–æ
                        </div>
                        <div class="summary-stat" style="color: #dc2626;" x-show="results.summary.failed > 0">
                            <strong x-text="results.summary.failed"></strong>
                            –û—à–∏–±–æ–∫
                        </div>
                    </div>
                </div>

                <template x-for="(item, index) in results.items" :key="index">
                    <div class="result-item" :class="item.error ? 'error' : 'success'">
                        <div>
                            <strong x-show="!item.error">‚úì –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ</strong>
                            <strong x-show="item.error">‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è</strong>
                        </div>
                        <div class="result-details">
                            URL: <code x-text="item.long_url"></code>
                        </div>

                        <template x-if="!item.error">
                            <div>
                                <div class="result-url-display">
                                    <input
                                            type="text"
                                            :value="item.short_url"
                                            readonly
                                            :id="'result-' + index"
                                    >
                                    <button
                                            class="btn btn-success btn-sm"
                                            @click="copyToClipboard(item.short_url, index)"
                                    >
                                        <span x-show="!item.copied">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                                        <span x-show="item.copied">‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</span>
                                    </button>
                                    <a
                                            :href="'/dashboard/stats/' + item.code"
                                            class="btn btn-sm"
                                            style="text-decoration: none;"
                                    >
                                        üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                                    </a>
                                </div>
                                <div class="result-details">
                                    –ö–æ–¥: <strong x-text="item.code"></strong>
                                </div>
                            </div>
                        </template>

                        <template x-if="item.error">
                            <div class="error-details">
                                <div><strong>–ö–æ–¥ –æ—à–∏–±–∫–∏:</strong> <span x-text="item.error.code"></span></div>
                                <div><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> <span x-text="item.error.message"></span></div>
                                <template x-if="item.error.details">
                                    <div style="margin-top: 4px;">
                                        <strong>–î–µ—Ç–∞–ª–∏:</strong>
                                        <pre style="margin-top: 4px; padding: 8px; background: #fff; border-radius: 4px; font-size: 12px;" x-text="JSON.stringify(item.error.details, null, 2)"></pre>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </template>
    </div>

    <h2>–ú–æ–∏ –¥–æ–º–µ–Ω—ã</h2>

    <template x-if="loading">
        <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–º–µ–Ω–æ–≤...</div>
    </template>

    <template x-if="error">
        <div class="error">
            <strong>–û—à–∏–±–∫–∞:</strong> <span x-text="error"></span>
        </div>
    </template>

    <template x-if="!loading && !error && domains.length > 0">
        <table>
            <thead>
            <tr>
                <th>–î–æ–º–µ–Ω</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°–æ–∑–¥–∞–Ω</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="domain in domains" :key="domain.domain">
                <tr>
                    <td>
                        <div class="domain-info">
                            <span class="domain-name" x-text="domain.domain"></span>
                            <span class="domain-desc" x-text="domain.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'"></span>
                        </div>
                    </td>
                    <td>
                                <span class="badge"
                                      :class="domain.is_active ? 'badge-success' : 'badge-danger'"
                                      x-text="domain.is_active ? '‚úì –ê–∫—Ç–∏–≤–µ–Ω' : '‚úó –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'">
                                </span>
                        <span class="badge badge-primary"
                              x-show="domain.is_default"
                              style="margin-left: 5px;">
                                    ‚òÖ Default
                                </span>
                    </td>
                    <td>
                        <div class="date-info" x-text="formatDate(domain.created_at)"></div>
                    </td>
                    <td>
                        <button class="btn" @click="viewDomain(domain.domain)">
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                        </button>
                    </td>
                </tr>
            </template>
            </tbody>
        </table>
    </template>

    <template x-if="!loading && !error && domains.length === 0">
        <div class="empty-state">
            <h3>üì≠ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤</h3>
            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –¥–æ–º–µ–Ω –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
        </div>
    </template>
</div>

<script>
    function dashboard() {
        return {
            domains: [],
            loading: true,
            error: null,
            stats: {
                totalDomains: '-',
                activeDomains: '-',
                defaultDomain: '-'
            },
            form: {
                urls: [
                    { url: '', custom_code: '', domain: '' }
                ],
                submitting: false
            },
            results: {
                show: false,
                summary: { total: 0, successful: 0, failed: 0 },
                items: []
            },

            get activeDomains() {
                return this.domains.filter(d => d.is_active);
            },

            async init() {
                await this.loadDomains();
            },

            async loadDomains() {
                try {
                    this.loading = true;
                    this.error = null;

                    const response = await fetch('/api/domains', {
                        headers: {
                            'Authorization': 'Bearer <token>'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.domains = data.items || [];

                    this.updateStats();

                } catch (err) {
                    this.error = err.message;
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–º–µ–Ω–æ–≤:', err);
                } finally {
                    this.loading = false;
                }
            },

            updateStats() {
                this.stats.totalDomains = this.domains.length;
                this.stats.activeDomains = this.domains.filter(d => d.is_active).length;
                const defaultDomain = this.domains.find(d => d.is_default);
                this.stats.defaultDomain = defaultDomain ? defaultDomain.domain : '–ù–µ –∑–∞–¥–∞–Ω';
            },

            addUrl() {
                this.form.urls.push({ url: '', custom_code: '', domain: '' });
            },

            removeUrl(index) {
                if (this.form.urls.length > 1) {
                    this.form.urls.splice(index, 1);
                }
            },

            async createShortLinks() {
                try {
                    this.form.submitting = true;
                    this.results.show = false;

                    // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ URLs, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
                    const urls = this.form.urls
                        .filter(item => item.url.trim())
                        .map(item => {
                            const urlItem = { url: item.url.trim() };
                            if (item.custom_code) urlItem.custom_code = item.custom_code;
                            if (item.domain) urlItem.domain = item.domain;
                            return urlItem;
                        });

                    if (urls.length === 0) {
                        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω URL');
                        return;
                    }

                    const response = await fetch('/api/shorten', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer <token>'
                        },
                        body: JSON.stringify({ urls })
                    });

                    const data = await response.json();

                    if (!response.ok && !data.summary) {
                        throw new Error(data.error || `HTTP ${response.status}`);
                    }

                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    this.results = {
                        show: true,
                        summary: data.summary,
                        items: data.items.map(item => ({
                            ...item,
                            copied: false
                        }))
                    };

                    // –ï—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ, –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    if (data.summary.failed === 0) {
                        this.form.urls = [{ url: '', custom_code: '', domain: '' }];
                    }

                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫: ' + err.message);
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫:', err);
                } finally {
                    this.form.submitting = false;
                }
            },

            resetForm() {
                this.form.urls = [{ url: '', custom_code: '', domain: '' }];
                this.results.show = false;
            },

            async copyToClipboard(text, index) {
                try {
                    await navigator.clipboard.writeText(text);
                    this.results.items[index].copied = true;
                    setTimeout(() => {
                        this.results.items[index].copied = false;
                    }, 2000);
                } catch (err) {
                    const input = document.getElementById('result-' + index);
                    input.select();
                    document.execCommand('copy');
                    this.results.items[index].copied = true;
                    setTimeout(() => {
                        this.results.items[index].copied = false;
                    }, 2000);
                }
            },

            formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            viewDomain(domain) {
                window.location.href = `/domain/${domain}`;
            }
        };
    }
</script>
</body>
</html>
