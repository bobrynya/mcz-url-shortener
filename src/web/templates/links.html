<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Å–µ —Å—Å—ã–ª–∫–∏ - MCZ URL Shortener</title>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { color: #333; }
        .breadcrumb { font-size: 14px; color: #6b7280; margin-bottom: 10px; }
        .breadcrumb a { color: #2563eb; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 28px; font-weight: bold; color: #2563eb; }

        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .filters-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 6px; }
        .filter-group input, .filter-group select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* –¢–∞–±–ª–∏—Ü–∞ —Å—Å—ã–ª–æ–∫ */
        .links-table { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
        th { background: #f9fafb; font-weight: 600; color: #374151; position: sticky; top: 0; z-index: 10; }
        tbody tr:hover { background: #f9fafb; }
        tbody tr:last-child td { border-bottom: none; }
        .short-link { font-family: monospace; color: #2563eb; text-decoration: none; }
        .short-link:hover { text-decoration: underline; }
        .long-url { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #6b7280; font-size: 13px; }
        .code-cell { font-family: monospace; font-weight: 600; color: #1f2937; }

        .loading { text-align: center; padding: 40px; color: #666; background: white; border-radius: 8px; }
        .error { background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 8px; }
        .btn { padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; }
        .btn:hover { background: #1d4ed8; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .actions { display: flex; gap: 8px; }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination { display: flex; justify-content: center; gap: 8px; padding: 20px; background: white; }
        .pagination button { padding: 8px 12px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .pagination button:hover:not(:disabled) { background: #f3f4f6; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination button.active { background: #2563eb; color: white; border-color: #2563eb; }

        .stats-badge { display: inline-block; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 12px; font-weight: 600; min-width: 30px; text-align: center; }
        .stats-badge.zero { background: #f3f4f6; color: #6b7280; }
        .stats-badge.high { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>
<div class="container" x-data="linksPage()" x-init="init()">
    <div class="breadcrumb">
        <a href="/dashboard/">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ dashboard</a>
    </div>

    <div class="header">
        <h1>üîó –í—Å–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Å—ã–ª–∫–∏</h1>
        <a href="/" class="btn">‚Üê –ù–∞–∑–∞–¥</a>
    </div>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <template x-if="!loading && totalLinks > 0">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ —Å—Å—ã–ª–æ–∫</h3>
                <div class="value" x-text="totalLinks"></div>
            </div>
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤</h3>
                <div class="value" x-text="totalClicks"></div>
            </div>
            <div class="stat-card">
                <h3>–°—Ä–µ–¥–Ω–µ –Ω–∞ —Å—Å—ã–ª–∫—É</h3>
                <div class="value" x-text="averageClicks"></div>
            </div>
        </div>
    </template>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters">
        <div class="filters-row">
            <div class="filter-group">
                <label for="domain">–î–æ–º–µ–Ω</label>
                <select
                        id="domain"
                        x-model="filters.domain"
                        @change="loadLinks(1)"
                >
                    <option value="">–í—Å–µ –¥–æ–º–µ–Ω—ã</option>
                    <template x-for="domain in domains" :key="domain">
                        <option :value="domain" x-text="domain"></option>
                    </template>
                </select>
            </div>
            <div class="filter-group">
                <label for="from">–û—Ç –¥–∞—Ç—ã</label>
                <input
                        type="date"
                        id="from"
                        x-model="filters.from"
                        @change="loadLinks(1)"
                >
            </div>
            <div class="filter-group">
                <label for="to">–î–æ –¥–∞—Ç—ã</label>
                <input
                        type="date"
                        id="to"
                        x-model="filters.to"
                        @change="loadLinks(1)"
                >
            </div>
            <div class="filter-group">
                <label for="page_size">–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
                <select
                        id="page_size"
                        x-model="filters.page_size"
                        @change="loadLinks(1)"
                >
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn btn-secondary" @click="resetFilters" style="width: 100%;">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <template x-if="loading">
        <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Å—ã–ª–æ–∫...</div>
    </template>

    <template x-if="error">
        <div class="error">
            <strong>–û—à–∏–±–∫–∞:</strong> <span x-text="error"></span>
        </div>
    </template>

    <template x-if="!loading && !error && links.length > 0">
        <div class="links-table">
            <table>
                <thead>
                <tr>
                    <th style="width: 140px;">–ö–æ–¥</th>
                    <th style="width: 250px;">–ö–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞</th>
                    <th>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL</th>
                    <th style="width: 80px; text-align: center;">–ö–ª–∏–∫–∏</th>
                    <th style="width: 160px;">–°–æ–∑–¥–∞–Ω–∞</th>
                    <th style="width: 200px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="link in links" :key="link.code">
                    <tr>
                        <td class="code-cell" x-text="link.code"></td>
                        <td>
                            <a :href="'https://' + link.domain + '/' + link.code" target="_blank" class="short-link" x-text="link.domain + '/' + link.code"></a>
                        </td>
                        <td>
                            <div class="long-url" :title="link.long_url">
                                <a :href="link.long_url" target="_blank" style="color: inherit; text-decoration: none;" x-text="link.long_url"></a>
                            </div>
                        </td>
                        <td style="text-align: center;">
                                    <span
                                            class="stats-badge"
                                            :class="{ 'zero': link.total === 0, 'high': link.total >= 10 }"
                                            x-text="link.total"
                                    ></span>
                        </td>
                        <td x-text="formatDate(link.created_at)"></td>
                        <td>
                            <div class="actions">
                                <a :href="'/dashboard/stats/' + link.code" class="btn btn-sm">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                                <button
                                        class="btn btn-sm"
                                        @click="copyLink('https://' + link.domain + '/' + link.code)"
                                        title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É"
                                >
                                    üìã
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>

            <div class="pagination" x-show="totalPages > 1">
                <button @click="loadLinks(1)" :disabled="currentPage === 1">–ü–µ—Ä–≤–∞—è</button>
                <button @click="loadLinks(currentPage - 1)" :disabled="currentPage === 1">‚Üê –ù–∞–∑–∞–¥</button>
                <template x-for="page in visiblePages" :key="page">
                    <button
                            @click="loadLinks(page)"
                            :class="{ 'active': page === currentPage }"
                            x-text="page"
                    ></button>
                </template>
                <button @click="loadLinks(currentPage + 1)" :disabled="currentPage === totalPages">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
                <button @click="loadLinks(totalPages)" :disabled="currentPage === totalPages">–ü–æ—Å–ª–µ–¥–Ω—è—è</button>
            </div>
        </div>
    </template>

    <template x-if="!loading && !error && links.length === 0">
        <div class="empty-state">
            <h3>üì≠ –°—Å—ã–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
            <p>–ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É</p>
            <a href="/" class="btn" style="margin-top: 20px;">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</a>
        </div>
    </template>
</div>

<script>
    function linksPage() {
        return {
            links: [],
            domains: [],
            loading: true,
            error: null,
            currentPage: 1,
            totalPages: 1,
            totalLinks: 0,
            filters: {
                domain: '',
                from: '',
                to: '',
                page_size: 25
            },

            get totalClicks() {
                return this.links.reduce((sum, link) => sum + link.total, 0);
            },

            get averageClicks() {
                if (this.totalLinks === 0) return 0;
                return Math.round(this.totalClicks / this.totalLinks * 10) / 10;
            },

            get visiblePages() {
                const pages = [];
                let start = Math.max(1, this.currentPage - 3);
                let end = Math.min(this.totalPages, this.currentPage + 3);

                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }

                return pages;
            },

            async init() {
                await this.loadDomains();
                await this.loadLinks(1);
            },

            async loadDomains() {
                try {
                    const response = await fetch('/api/domains', {
                        headers: {
                            'Authorization': 'Bearer <token>'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.domains = data.items.map(d => d.domain);
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–º–µ–Ω–æ–≤:', err);
                }
            },

            async loadLinks(page = 1) {
                try {
                    this.loading = true;
                    this.error = null;

                    // –§–æ—Ä–º–∏—Ä—É–µ–º query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                    const params = new URLSearchParams({
                        page: page.toString(),
                        page_size: this.filters.page_size.toString()
                    });

                    if (this.filters.domain) {
                        params.append('domain', this.filters.domain);
                    }

                    if (this.filters.from) {
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º date –≤ RFC3339
                        const fromDate = new Date(this.filters.from);
                        params.append('from', fromDate.toISOString());
                    }

                    if (this.filters.to) {
                        const toDate = new Date(this.filters.to);
                        toDate.setHours(23, 59, 59, 999); // –ö–æ–Ω–µ—Ü –¥–Ω—è
                        params.append('to', toDate.toISOString());
                    }

                    const response = await fetch(`/api/stats?${params}`, {
                        headers: {
                            'Authorization': 'Bearer <token>'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();

                    this.links = data.items || [];
                    this.currentPage = data.pagination.page;
                    this.totalPages = data.pagination.total_pages;
                    this.totalLinks = data.pagination.total_items;

                } catch (err) {
                    this.error = err.message;
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–æ–∫:', err);
                } finally {
                    this.loading = false;
                }
            },

            resetFilters() {
                this.filters = {
                    domain: '',
                    from: '',
                    to: '',
                    page_size: 25
                };
                this.loadLinks(1);
            },

            async copyLink(url) {
                try {
                    await navigator.clipboard.writeText(url);
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                }
            },

            formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleString('ru-RU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        };
    }
</script>
</body>
</html>
