# mcz-url-shortener

Production-ready URL shortener –Ω–∞ Rust —Å —á–∏—Å—Ç–æ–π —Å–ª–æ–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π (Clean Architecture), –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –Ω–∞ axum + sqlx + PostgreSQL.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫**: `POST /shorten` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫
- **–£–º–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ URL –∫ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–π —Ñ–æ—Ä–º–µ (lowercase host, —É–¥–∞–ª–µ–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤, –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤)
- **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è**: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ URL –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–∞—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–æ–¥
- **–†–µ–¥–∏—Ä–µ–∫—Ç**: `GET /{code}` –≤—ã–ø–æ–ª–Ω—è–µ—Ç 302 —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞**: –∫–ª–∏–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ in-memory –æ—á–µ—Ä–µ–¥—å –∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞ —Å retry-–ª–æ–≥–∏–∫–æ–π

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- **–°–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫**: `GET /stats` ‚Äî –≤—Å–µ —Å—Å—ã–ª–∫–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–ª–∏–∫–æ–≤
- **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: `GET /stats/{code}` ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–ª–∏–∫–æ–≤ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Å—ã–ª–∫–µ
- **–ü–∞–≥–∏–Ω–∞—Ü–∏—è**: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `page` –∏ `page_size` (10-50, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 25)
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º**: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `from` –∏ `to` –≤ —Ñ–æ—Ä–º–∞—Ç–µ RFC3339
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–æ–º–µ–Ω—É**: –ø–∞—Ä–∞–º–µ—Ç—Ä `domain` (—Å—Ç—Ä–æ–∫–∞)
- **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–ª–∏–∫–æ–≤**: IP-–∞–¥—Ä–µ—Å, User-Agent, Referer, –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤**: `GET /domains` ‚Äî –≤—Å–µ –¥–æ–º–µ–Ω—ã
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞**: `GET /health` ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: Bearer token –¥–ª—è –∑–∞—â–∏—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- **–î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏**: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON-–æ—Ç–≤–µ—Ç—ã —Å –∫–æ–¥–∞–º–∏ –∏ –¥–µ—Ç–∞–ª—è–º–∏
- **Access log**: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç–∏–ª–µ nginx (IP, –º–µ—Ç–æ–¥, –ø—É—Ç—å, —Å—Ç–∞—Ç—É—Å, latency)
- **–ú–µ—Ç—Ä–∏–∫–∏**: —Å—á—ë—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫ –ë–î –ø–æ —Ç–∏–ø–∞–º –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **Graceful error handling**: —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –ë–î –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Clean Architecture** (—Å–ª–æ–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞) –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏ –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç–∏:

```
src/
‚îú‚îÄ‚îÄ lib.rs                     \# –ö–æ–º–ø–æ–∑–∏—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
‚îú‚îÄ‚îÄ main.rs                    \# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
‚îú‚îÄ‚îÄ server.rs                  \# –°–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ error.rs                   \# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ + –º–∞–ø–ø–∏–Ω–≥ sqlx::Error
‚îú‚îÄ‚îÄ config.rs                  \# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ api/                       \# Presentation Layer
‚îú‚îÄ‚îÄ ‚îú‚îÄ‚îÄ routes.rs 
‚îÇ   ‚îú‚îÄ‚îÄ dto/                   \# Request/Response models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clicks.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pagination.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shorten.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stats.rs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stats_list.rs
‚îÇ   ‚îú‚îÄ‚îÄ handlers/              \# HTTP handlers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domains.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redirect.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shorten.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stats.rs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stats_list.rs
‚îÇ   ‚îî‚îÄ‚îÄ middleware/            \# HTTP middleware
‚îÇ       ‚îú‚îÄ‚îÄ auth.rs
‚îÇ       ‚îú‚îÄ‚îÄ rate_limit.rs
‚îÇ       ‚îî‚îÄ‚îÄ tracing.rs
‚îú‚îÄ‚îÄ application/               \# Application Layer
‚îÇ   ‚îî‚îÄ‚îÄ services/              \# –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ       ‚îú‚îÄ‚îÄ auth_service.rs    \# –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ domain_service.rs  \# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ link_service.rs    \# –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∞–º–∏
‚îÇ       ‚îî‚îÄ‚îÄ stats_service.rs   \# –†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îî‚îÄ‚îÄ admin.rs               \# CLI
‚îú‚îÄ‚îÄ domain/                    \# Domain Layer
‚îÇ   ‚îú‚îÄ‚îÄ click_event.rs         \# –°–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ click_worker.rs        \# –í–æ—Ä–∫–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ entities/              \# –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ click.rs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain.rs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ link.rs
‚îÇ   ‚îî‚îÄ‚îÄ repositories/          \# Trait-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
‚îÇ       ‚îú‚îÄ‚îÄ domain_repository.rs
‚îÇ       ‚îú‚îÄ‚îÄ link_repository.rs
‚îÇ       ‚îú‚îÄ‚îÄ stats_repository.rs
‚îÇ       ‚îî‚îÄ‚îÄ token_repository.rs
‚îú‚îÄ‚îÄ infrastructure/            \# Infrastructure Layer
‚îÇ   ‚îî‚îÄ‚îÄ persistence/           \# PostgreSQL —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
‚îÇ       ‚îú‚îÄ‚îÄ pg_domain_repository.rs
‚îÇ       ‚îú‚îÄ‚îÄ pg_link_repository.rs
‚îÇ       ‚îú‚îÄ‚îÄ pg_stats_repository.rs
‚îÇ       ‚îî‚îÄ‚îÄ pg_token_repository.rs
‚îî‚îÄ‚îÄ utils/                     \# –£—Ç–∏–ª–∏—Ç—ã
    ‚îú‚îÄ‚îÄ code_generator.rs
    ‚îú‚îÄ‚îÄ extract_domain.rs
    ‚îî‚îÄ‚îÄ url_normalizer.rs
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**: –∫–∞–∂–¥—ã–π —Å–ª–æ–π –∏–º–µ–µ—Ç —á—ë—Ç–∫—É—é –∑–æ–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏  
‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç HTTP –∏ –ë–î  
‚úÖ **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤**: domain –Ω–µ –∑–Ω–∞–µ—Ç –æ–± axum –∏–ª–∏ sqlx  
‚úÖ **–õ–µ–≥–∫–∞—è –∑–∞–º–µ–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**: –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å PostgreSQL –Ω–∞ MySQL –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã  

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Rust**: stable toolchain + cargo
- **PostgreSQL**: 14+ (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ —á–µ—Ä–µ–∑ Docker)
- **sqlx-cli**: –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∏–ª–∏ `.env` —Ñ–∞–π–ª):

```env
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
DATABASE_URL=postgres://postgres:postgres@127.0.0.1:5432/shorty
BASE_URL=https://s.test.com
LISTEN=0.0.0.0:3000

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
RUST_LOG=info,mcz_url_shortener=debug
```

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
| :-- | :-- | :-- |
| `DATABASE_URL` | –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL | `postgres://user:pass@host/db` |
| `BASE_URL` | –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å—Å—ã–ª–æ–∫ | `https://s.example.com` |
| `LISTEN` | –ê–¥—Ä–µ—Å –∏ –ø–æ—Ä—Ç –¥–ª—è HTTP —Å–µ—Ä–≤–µ—Ä–∞ | `0.0.0.0:3000` |
| `RUST_LOG` | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | `info` / `debug` / `trace` |

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ sqlx-cli

```bash
cargo install sqlx-cli --no-default-features --features postgres
```


### 2. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞—Ç—å –ë–î
sqlx database create

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
sqlx migrate run
```


### 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ offline-—Ä–µ–∂–∏–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .sqlx/ –¥–ª—è compile-time –ø—Ä–æ–≤–µ—Ä–∫–∏ SQL –±–µ–∑ –ë–î
cargo sqlx prepare -- --bin mcz-url-shortener
```


### 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
# Development —Ä–µ–∂–∏–º
cargo run

# Production build
cargo build --release
./target/release/mcz-url-shortener
```


## üì° API Reference

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å—Å—ã–ª–æ–∫

**Endpoint:** `POST /shorten`

**Content-Type:** `application/json`

**Request Body:**

`domain` - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–ª—é—á, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—Ç—å, —Ç–æ —Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∞ –∫ –¥–æ–º–µ–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
`custom_code` - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–ª—é—á, –∂–µ–ª–∞–µ–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–ª—é—á, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–ª—É—á–∞–π–Ω—ã–π

```json
{
  "urls": [
    {
      "url": "https://chernyakov.com/very/long/path111333",
      "custom_code": "promo2029"
    },
    {
      "url": "https://example.com/another/path1111asd/zzzz/",
      "domain": "s.example.com1",
      "custom_code": "winter-sale"
    },
    {
      "url": "https://github.com/rust-lang/rust/pull-requests/"
    }
  ]
}
```

**Response:** `200 OK`

```json
{
  "summary": {
    "total": 3,
    "successful": 1,
    "failed": 2
  },
  "items": [
    {
      "long_url": "https://chernyakov.com/very/long/path111333",
      "error": {
        "code": "conflict",
        "message": "Custom code already exists for this domain",
        "details": {
          "code": "promo2029",
          "domain_id": 1
        }
      }
    },
    {
      "long_url": "https://example.com/another/path1111asd/zzzz/",
      "error": {
        "code": "not_found",
        "message": "Domain not found",
        "details": {
          "domain": "s.example.com1"
        }
      }
    },
    {
      "long_url": "https://github.com/rust-lang/rust/pull-requests/",
      "code": "qh3h-ccXXRgY",
      "short_url": "https://s.example.com/qh3h-ccXXRgY"
    }
  ]
}
```
–í –æ—Ç–≤–µ—Ç–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –µ—Å–ª–∏ —Å—Å—ã–ª–∫—É –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ –∫–∞–∫–æ–π –ª–∏–±–æ –ø—Ä–∏—á–∏–Ω–µ, –∫–ª—é—á `error` –ø–æ–∫–∞–∂–µ—Ç –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏.

**–ü—Ä–∏–º–µ—Ä —Å curl:**
```bash
curl -X POST http://127.0.0.1:3000/shorten \
  -H 'Content-Type: application/json' \
  -d '{
    "urls": [
      {
        "url": "https://chernyakov.com/very/long/path111333",
        "custom_code": "promo2029"
      },
      {
        "url": "https://example.com/another/path1111asd/zzzz/",
        "domain": "s.example.com1",
        "custom_code": "winter-sale"
      },
      {
        "url": "https://github.com/rust-lang/rust/pull-requests/"
      }
    ]
  }' | jq
```


---

### –†–µ–¥–∏—Ä–µ–∫—Ç –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–º—É –∫–æ–¥—É

**Endpoint:** `GET /{code}`

**Response:** `302 Found`

```http
Location: https://example.com/very/long/path
```

**–ü—Ä–∏–º–µ—Ä:**

```bash
curl -i http://127.0.0.1:3000/3c1930ac8e
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**

- –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ (IP, User-Agent, Referer)

---

### –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

**Endpoint:** `GET /stats`

**Authorization:** `Bearer <token>` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**Query Parameters:**


| –ü–∞—Ä–∞–º–µ—Ç—Ä    | –¢–∏–ø     | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ                     |
|:------------|:--------| :-- |:-----------------------------|
| `page`      | integer | 1 | –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞—á–∏–Ω–∞—è —Å 1) |
| `page_size` | integer | 25 | –†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (10-50)      |
| `from`      | RFC3339 | - | –§–∏–ª—å—Ç—Ä: –∫–ª–∏–∫–∏ –æ—Ç –¥–∞—Ç—ã        |
| `to`        | RFC3339 | - | –§–∏–ª—å—Ç—Ä: –∫–ª–∏–∫–∏ –¥–æ –¥–∞—Ç—ã        |
| `domain`    | string  | - | –§–∏–ª—å—Ç—Ä: –ø–æ –¥–æ–º–µ–Ω—É            |

**Response:** `200 OK`

```json
{
  "pagination": {
    "page": 1,
    "page_size": 25,
    "total_items": 157,
    "total_pages": 7
  },
  "items": [
    {
      "code": "3c1930ac8e",
      "domain": "s.example.com",
      "long_url": "https://example.com",
      "total": 42,
      "created_at": "2026-01-16T10:30:00Z"
    }
  ]
}
```

**–ü—Ä–∏–º–µ—Ä:**

```bash
curl "http://127.0.0.1:3000/stats?page=1&page_size=10" \
  -H "Authorization: Bearer YOUR_TOKEN" | jq
```


---

### –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–¥—É

**Endpoint:** `GET /stats/{code}`

**Authorization:** `Bearer <token>` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**Query Parameters:** —Ç–µ –∂–µ —á—Ç–æ –∏ —É `/stats`

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω `domain` –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö, —Ç–æ –±—É–¥–µ—Ç –≤—ã–≤–µ–¥–µ–Ω–∞ –ø–µ—Ä–≤–∞—è –ø–æ–¥—Ö–æ–¥—è—â–∞—è —Å—Å—ã–ª–∫–∞

**Response:** `200 OK`

```json
{
  "pagination": {
    "page": 1,
    "page_size": 25,
    "total_items": 42,
    "total_pages": 2
  },
  "code": "3c1930ac8e",
  "domain": "s.example.com",
  "long_url": "https://example.com",
  "created_at": "2026-01-16T10:30:00Z",
  "total": 42,
  "items": [
    {
      "clicked_at": "2026-01-16T18:45:23Z",
      "user_agent": "Mozilla/5.0...",
      "referer": "https://news.ycombinator.com/",
      "ip": "203.0.113.42"
    }
  ]
}
```

**–ü—Ä–∏–º–µ—Ä —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π:**

```bash
curl "http://127.0.0.1:3000/stats/3c1930ac8e?from=2026-01-01T00:00:00Z&to=2026-01-16T23:59:59Z" \
  -H "Authorization: Bearer YOUR_TOKEN" | jq
```

---

### –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞

**Endpoint:** `GET /health`

**Authorization:** `Bearer <token>` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**Response:** `200 OK`

```json
{
  "status": "healthy",
  "version": "0.1.0",
  "checks": {
    "database": {
      "status": "ok",
      "message": "Connected, default domain: s.example.com"
    },
    "click_queue": {
      "status": "ok",
      "message": "Capacity: 10000"
    }
  }
}
```

**–ü—Ä–∏–º–µ—Ä:**

```bash
curl "http://127.0.0.1:3000/health" \
  -H "Authorization: Bearer YOUR_TOKEN" | jq
```

---

### –°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤

**Endpoint:** `GET /domains`

**Authorization:** `Bearer <token>` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

**Response:** `200 OK`

```json
{
  "items": [
    {
      "domain": "s.example.com",
      "is_default": true,
      "is_active": true,
      "description": "Default domain",
      "created_at": "2026-01-17T08:22:13.685467Z",
      "updated_at": "2026-01-17T08:22:13.685467Z"
    }
  ]
}
```

**–ü—Ä–∏–º–µ—Ä:**

```bash
curl "http://127.0.0.1:3000/domains" \
  -H "Authorization: Bearer YOUR_TOKEN" | jq
```
---

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–ó–∞—â–∏—â—ë–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
* `GET /stats`
* `GET /stats/{code}`
* `GET /health`
* `GET /domains`

**–§–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞:**

```http
Authorization: Bearer <your-token>
```

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞** (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î):

```sql
-- –í—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω (—Ö—Ä–∞–Ω–∏—Ç—Å—è SHA256 —Ö–µ—à)
INSERT INTO api_tokens (name, token_hash)
VALUES ('My App', encode(sha256('your-secret-token'::bytea), 'hex'));
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```bash
export TOKEN="your-secret-token"
curl -H "Authorization: Bearer $TOKEN" http://127.0.0.1:3000/stats
```


---

## ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í—Å–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –µ–¥–∏–Ω–æ–º JSON-—Ñ–æ—Ä–º–∞—Ç–µ:

```json
{
  "error": {
    "code": "validation_error",
    "message": "Invalid URL format",
    "details": {
      "reason": "Only HTTP and HTTPS protocols are allowed"
    }
  }
}
```

**–¢–∏–ø—ã –æ—à–∏–±–æ–∫:**


| HTTP Status | Error Code | –û–ø–∏—Å–∞–Ω–∏–µ |
| :-- | :-- | :-- |
| 400 | `validation_error` | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| 401 | `unauthorized` | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω |
| 404 | `not_found` | –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω |
| 409 | `conflict` | –ö–æ–Ω—Ñ–ª–∏–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥—É–±–ª–∏–∫–∞—Ç) |
| 500 | `internal_error` | –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ |

**–ü—Ä–∏–º–µ—Ä—ã:**

–ù–µ–≤–µ—Ä–Ω—ã–π URL
```json
{
  "error": {
    "code": "validation_error",
    "message": "Invalid URL format",
    "details": { "reason": "Invalid URL: relative URL without a base" }
  }
}
```
–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω
```json
{
  "error": {
    "code": "not_found",
    "message": "Short link not found",
    "details": { "code": "unknown123" }
  }
}
```

–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
```json
{
  "error": {
    "code": "unauthorized",
    "message": "Unauthorized",
    "details": { "reason": "Invalid or revoked token" }
  }
}
```
---
## üö¶Rate Limiting

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç IP-based rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π.

### –ü—É–±–ª–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ `/shorten` –∏ `/{code}`:
- **–õ–∏–º–∏—Ç**: 2 –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥—É (120 req/min)
- **Burst**: –¥–æ 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –µ–¥–∏–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ö–ª—é—á**: IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞

### –ó–∞—â–∏—â—ë–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ `/health`, `/domains`, `/stats`, `/stats/{code}`:
- **–õ–∏–º–∏—Ç**: 1 –∑–∞–ø—Ä–æ—Å –≤ —Å–µ–∫—É–Ω–¥—É (60 req/min)
- **Burst**: –¥–æ 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –µ–¥–∏–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ö–ª—é—á**: IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç HTTP `429 Too Many Requests`. –°—á—ë—Ç—á–∏–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º `per_second`.

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `tracing` –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤:

```bash
# –¢–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
RUST_LOG=info cargo run

# –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞
RUST_LOG=debug,mcz_url_shortener=trace cargo run
```

### –ú–µ—Ç—Ä–∏–∫–∏

–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ (—á–µ—Ä–µ–∑ `metrics` crate):

- `click_worker_received_total` ‚Äî —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–∫–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ
- `click_worker_processed_total` ‚Äî —Å–æ–±—ã—Ç–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
- `click_worker_failed_total` ‚Äî –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `click_worker_retried_total` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ retry
- `database_errors_total{type="..."}` ‚Äî –æ—à–∏–±–∫–∏ –ë–î –ø–æ —Ç–∏–ø–∞–º
---

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

---

## ü§ù Contributing

Pull requests –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è! –î–ª—è –∫—Ä—É–ø–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ issue –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.

---

## üîó –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Axum Documentation](https://docs.rs/axum)
- [SQLx Documentation](https://docs.rs/sqlx)
- [Clean Architecture by Robert Martin](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
